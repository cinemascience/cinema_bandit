<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset="utf-8">
	<meta name='author' content='Dan Orban'>
	<meta name='author' content="Cameron Tauxe">
	<link rel='stylesheet' href='css/parallelCoordinates.css'>
	<link rel='stylesheet' href='css/lineChart.css'>
	<link rel='stylesheet' href='css/bandit.css'>
	<script src="lib/d3.min.js"></script>
	<script src="lib/jquery-3.2.1.min.js"></script>
	<script src = 'lib/ParallelCoordinatesChart.js'></script>
	<script src = 'lib/LineChart.js'></script>
</head>
<body>
	<div id="topHalf">
		<div id="header">
			<h1>Bandit</h1>
			<select id="database" onchange="load()">
				<option value="GF-HP/GF-HP.csv">GF-HP</option>
				<option value="GF-LP/GF-LP.csv">F-LP</option>
				<option value="LANLHigh-O/LANLHigh-O.csv">LANLHigh-O</option>
				<option value="LANLLow-O/LANLLow-O.csv">LANLLow-O</option>
				<option value="simresults/Al.design.1000.numbered.csv">Flag Simulation</option>
			</select>
		</div>
		<div id="svgArea">
			<div id="svgContainer"></div>
		</div>
		<div id="resizeBar"></div>
	</div>
	<div id="bottomHalf">
		<div id="sidebar">
			<div id="visarSocketContainer" class="sidebarThird">
				<span>Visar</span>
				<div id="visarSocket" class="socket">
					<div id="visarSocketOverlay" class="socketOverlay" mode="empty"></div>
				</div>
			</div>
			<div id="diffractionSocketContainer" class="sidebarThird">
				<span>Diffraction Graph</span>
				<div id="diffractionSocket" class="socket">
					<div id="diffractionContainer" class="viewContainer"></div>
					<div id="diffractionSocketOverlay" class="socketOverlay" mode="filled"></div>
				</div>
			</div>
			<div id="diffractionImageSocketContainer" class="sidebarThird">
				<span>Diffraction Image</span>
				<div id="diffractionImageSocket" class="socket">
					<div id="diffractionImageContainer" class="viewContainer">
						<img id="diffractionImage2" class="diffractionImage">
						<img id="diffractionImage1" class="diffractionImage">
					</div>
					<div id="diffractionImageSocketOverlay" class="socketOverlay" mode="filled"></div>
				</div>
			</div>
		</div>
		<div id="toolbar">
			<div id = "tooltip">
				Scroll to zoom, click-and-drag to pan.
			</div>
			<ul id="toolList">
				<li id="zoomTool" class="tool" mode="unselected">Zoom/Pan
				<li id="eraseTool" class="tool" mode="unselected">Erase
				<li id="includeTool" class="tool" mode="unselected">Include
				<!--The closing tags are excluded because having whitespace between each li adds spaces into the webpage-->
			</ul>
		</div>
		<div id="resultsArea">
			<div id = "mainViewSocket" class="socket">
				<div id="visarContainer" class="viewContainer"></div>
			</div>
		</div>
	</div>

	<script>
		var chartLoaded = false;
		var chart;
		var diffractionChart;
		var visarChart;

		var alwaysHighlighted = [];

		$(document).ready(function() {
			updateBottomHalf();
			load();
		});

		var lastQuery = [];

		//Set up dragging on the resize bar
		var resizeDrag = d3.drag()
			.on('start', function() {
				d3.select(this).attr('mode', 'dragging');
			})
			.on('drag', function() {
				var headerRect = d3.select('#header').node().getBoundingClientRect();
				d3.select('#svgArea').style('height',(d3.event.y - headerRect.height)+'px');
				updateBottomHalf();
			})
			.on('end', function() {
				d3.select(this).attr('mode', 'default');
				chart.updateSize();
				diffractionChart.updateSize();
				visarChart.updateSize();
			});
		d3.select('#resizeBar').call(resizeDrag);

		$('.socketOverlay')
			.on('click', function() {
				if ($(this).attr('mode') == 'filled') {
					var currentView = $('#mainViewSocket .viewContainer');
					var socketContents = $(this).parent().children('.viewContainer');
					//place current view back into its socket
					switch (currentView.attr('id')) {
						case "visarContainer":
							currentView.insertBefore('#visarSocketOverlay');
							$('#visarSocketOverlay').attr('mode','filled');
							visarChart.updateSize();
							break;
						case "diffractionContainer":
							currentView.insertBefore('#diffractionSocketOverlay');
							$('#diffractionSocketOverlay').attr('mode','filled');
							diffractionChart.updateSize();
							break;
						case "diffractionImageContainer":
							currentView.insertBefore('#diffractionImageSocketOverlay');
							$('#diffractionImageSocketOverlay').attr('mode','filled');
							$('#toolbar').slideDown(500);
							$('#resultsArea').animate({top: '65px'},callback=function() {
								if (socketContents.attr('id') == 'visarContainer')
									visarChart.updateSize();
								else
									diffractionChart.updateSize();
							});
					}
					//Place socket contents into main view
					$('#mainViewSocket').append(socketContents);
					$(this).attr('mode',"empty");
					switch (socketContents.attr('id')) {
						case "visarContainer":
							visarChart.updateSize();
							break;
						case "diffractionContainer":
							diffractionChart.updateSize();
							break;
						case "diffractionImageContainer":
							$('#toolbar').slideUp(500);
							$('#resultsArea').animate({top: '5px'});
					}
				}
			});

		$('.tool')
			.on('click', function() {
				if ($(this).attr('mode') == 'unselected') {
					$('.tool[mode="selected"]').attr('mode','unselected');
					$(this).attr('mode','selected');
					switch ($(this).attr('id')) {
						case "zoomTool":
							visarChart.setMode("zoom");
							diffractionChart.setMode("zoom");
							$('#tooltip').text("Scroll to zoom, click-and-drag to pan.");
							break;
						case "eraseTool":
							visarChart.setMode("erase");
							diffractionChart.setMode("erase");
							$('#tooltip').text("Drag over results to grey them out.");
							break;
						case "includeTool":
							visarChart.setMode("include");
							diffractionChart.setMode("include");
							$('#tooltip').text("Drag over erased results to see them again");
					}
				}
			})

		//https://stackoverflow.com/a/5926068
		var rtime;
		var timeout = false;
		var delta = 200;
		$(window).resize(function() {
			rtime = new Date();
			if (timeout === false) {
				timeout = true;
				setTimeout(resizeend, delta);
			}
		});

		function resizeend() {
			if (new Date() - rtime < delta) {
				setTimeout(resizeend, delta);
			} else {
				timeout = false;
				chart.updateSize();
				diffractionChart.updateSize();
				visarChart.updateSize();
			}
		}

		function load() {
			$('#svgContainer').html('');
			$('#visarContainer').html('');
			$('#diffractionContainer').html('');
			$('#diffractionImage1').attr("src", "Ti-data/Ti-XRD-composite-images/output.jpg");
			$('#diffractionImage2').attr("src", "Ti-data/Ti-XRD-composite-images/output.jpg");

			if ($('#zoomTool').attr('mode') != 'selected') {
				$('.tool[mode="selected"]').attr('mode','unselected');
				$('#zoomTool').attr('mode','selected');
			}

			dbName = d3.select('#database').node().value;
			console.log(dbName);

			chart = new ParallelCoordinatesChart(d3.select('#svgContainer'),dbName,[],doneLoading);

			diffractionChart = new LineChart(d3.select('#diffractionContainer'), getDiffData);
			
			if (dbName == "simresults/Al.design.1000.numbered.csv") {
				visarChart = new LineChart(d3.select('#visarContainer'), getVisarData2);
			}
			else {
				visarChart = new LineChart(d3.select('#visarContainer'), getVisarData);
			}
		}

		function doneLoading() {
			chartLoaded = true;

			//Add listeners for chart
			chart.dispatch.on('selectionchange', onSelectionChange);
			chart.dispatch.on('mouseover', onMouseOverChange);

			// Initialize lines
			var resultIndices = Array.apply(null, Array(chart.results.length)).map(function (_, i) {return i;});
			diffractionChart.loadData(resultIndices, function() {
				diffractionChart.updateSize();
			});
			visarChart.loadData(resultIndices, function() {
				visarChart.updateSize();
			});

			diffractionChart.dispatch.on("mouseover", onMouseOverChange);
			visarChart.dispatch.on("mouseover", onMouseOverChange);
			diffractionChart.dispatch.on("erase",onErase);
			visarChart.dispatch.on("erase",onErase);
			diffractionChart.dispatch.on("include",onInclude);
			visarChart.dispatch.on("include",onInclude);


		}

		function onSelectionChange(query) {
			lastQuery = query;
			if (visarChart.dataLoaded)
				visarChart.setSelection(query);
			if (diffractionChart.dataLoaded)
				diffractionChart.setSelection(query);
		}

		function onErase(i) {
			visarChart.eraseData(i);
			diffractionChart.eraseData(i);
			$('.pCoordChart .resultPaths path[index="'+i+'"]')
				.attr('mode','erased');
		}

		function onInclude(i) {
			visarChart.includeData(i);
			diffractionChart.includeData(i);
			$('pCoordChart .resultPaths path[index="'+i+'"]')
				.attr('mode','active');
		}

		function onMouseOverChange(i, event) {
			if (this !== chart && chartLoaded) {
				chart.setHighlight(i);
			}

			if (i != null) {
				var id = chart.results[i].run;
				diffractionChart.setHighlight([i].concat(alwaysHighlighted));
				visarChart.setHighlight([i].concat(alwaysHighlighted));
				if (dbName == "simresults/Al.design.1000.numbered.csv") {
					fileName = "Ti-data/Ti-XRD-composite-images/output.jpg";
					fileName2 = "Ti-data/Ti-XRD-composite-images/output.jpg";
				}
				else {
					var fileName = "Ti-data/Ti-XRD-composite-images/r"+ pad(id, 4) + "-e001-140506-Composite.tif.jpg";
					if (id >= 223 && id <= 372) {
						fileName = "Ti-data/Ti-XRD-composite-images/r"+ pad(id, 3) + "-e001-140506-Composite.tif.jpg";
					}
					var fileName2 = "Ti-data/Ti-XRD-composite-images/r"+ pad(id, 4) + "-e002-140506-Composite.tif.jpg";
					if (id >= 223 && id <= 372) {
						fileName2 = "Ti-data/Ti-XRD-composite-images/r"+ pad(id, 3) + "-e002-140506-Composite.tif.jpg";
					}
				}
				d3.select('#diffractionImage1').attr("src", fileName);
				d3.select('#diffractionImage2').attr("src", fileName2);
			}
			else {
				diffractionChart.setHighlight(alwaysHighlighted);
				visarChart.setHighlight(alwaysHighlighted);
			}
		}

		function updateBottomHalf() {
			var topRect = d3.select('#topHalf').node().getBoundingClientRect();
			d3.select('#bottomHalf').style('top',topRect.height+'px');
		}

		function pad(num, size){ return ('000000000' + num).substr(-size); }
		
		function getDiffData(i) {
			if (chartLoaded) {
				var id = chart.results[i].run;
				return [
					{file: "_1DSpectra/r" + pad(id,4) + "-e00000001-spectrum.txt", color: "blue", columnX: -1, columnY: -1},
					{file: "_1DSpectra/r" + pad(id,4) + "-e00000002-spectrum.txt", color: "red", columnX: -1, columnY: -1}];
			}

			return null;
		}

		function getVisarData(i) {
			if (chartLoaded) {
				var id = chart.results[i].run;
				return [
					{file: "visar/r" + pad(id,3) + "-visar.txt", color: "blue", columnX: -1, columnY: 0},
					{file: "visar/r" + pad(id,3) + "-visar.txt", color: "red", columnX: -1, columnY: 1}];
			}

			return null;
		}

		function getVisarData2(i) {
			if (chartLoaded) {
				var id = i+1;
				var experiment = chart.results[i].Experiment;
				if (experiment == 1) {
					alwaysHighlighted.push(i);
					return [{file: "Boetler-data/Data_S" + pad(chart.results[i].id,3) + "E.txt", color: "red", columnX: 3, columnY: 2}];
				}
				else {
					return [
						{file: "simresults/Shot104S_" + pad(id,3) + "_TitleAl5083.FreeSurface.000001", color: "blue", columnX: 1, columnY: 3, delimiter: " "}];
				}
			}

			return null;
		}
	</script>
</body>
