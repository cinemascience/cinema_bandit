<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset="utf-8">
	<meta name='author' content="Cameron Tauxe">
	<link rel='stylesheet' href='example.css'>
	<script src="d3.v3.min.js"></script>
	<script src="d3-queue.min.js"></script>
	<script src = 'ParallelCoordinatesChart.js'></script>
	<script src = 'LineChart.js'></script>
</head>
<body>
	<div id="header">
		<h1>Cinema Database Explorer</h1>
		<select id="database" onchange="load()">
			<option value="GF-HP/GF-HP.csv">GF-HP</option>
			<option value="GF-LP/GF-LP.csv">F-LP</option>
			<option value="LANLHigh-O/LANLHigh-O.csv">LANLHigh-O</option>
			<option value="LANLLow-O/LANLLow-O.csv">LANLLow-O</option>
			<option value="LANLMed-O/LANLMed-O.csv">LANLMed-O</option>
			<option value="simresults/Al.design.1000.numbered.csv">Flag Simulation</option>
		</select>
	</div>
	<div id="svgArea">
		<div id="svgContainer"></div>
	</div>
	<div id="resultsArea" style="margin-left: auto; margin-right: auto;" width="100%">
		<!--canvas width="600" height="500" id="diffCanvas"></canvas-->
		<div id="visar" class="lineChart"></div>
		<div id="diffraction1D" class="lineChart"></div>
		<div id="diffraction2D" class="lineChart"></div>
		<div id="selectionReadout"></div>
		<div id="mouseOverReadout"></div>
	</div>

	<script>
		var loaded = false;
		var chart;
		var diffractionChart;
		var visarChart;
		var diffractionImage;
		load();

		function load() {

			d3.select('#svgContainer').html('');
			d3.select('#visar').html('');
			d3.select('#diffraction1D').html('');
			d3.select('#diffraction2D').html('');

			dbName = d3.select('#database').node().value;
			console.log(dbName);

			chart = new ParallelCoordinatesChart(d3.select('#svgContainer'),
												dbName,
												//'GF-HP/GF-HP.csv',
												//'GF-LP/GF-LP.csv',
												//'LANLHigh-O/LANLHigh-O.csv',
												//'LANLLow-O/LANLLow-O.csv',
												//'LANLMed-O/LANLMed-O.csv',
												//'simresults/Al.design.3.numbered.csv',
												//'simresults/Al.design.1000.numbered.csv',
												doneLoading,
												onSelectionChange,
												onMouseOverChange);
			diffractionChart = new LineChart(d3.select('#diffraction1D'), getDiffData, onLineHover);
			diffractionImage = new LineChart(d3.select('#diffraction2D'), getDiffData, onLineHover);
			
			if (dbName == "simresults/Al.design.1000.numbered.csv") {
				visarChart = new LineChart(d3.select('#visar'), getVisarData2, onLineHover);
			}
			else {
				visarChart = new LineChart(d3.select('#visar'), getVisarData, onLineHover);
			}
		}

		function doneLoading() {
			loaded = true;

			// Initialize lines
			var resultIndices = Array.apply(null, Array(chart.results.length)).map(function (_, i) {return i;});
			//diffractionChart.drawData(resultIndices, true, "lightgrey");
			diffractionChart.loadData(resultIndices);
			visarChart.loadData(resultIndices);
		}

		window.onresize = function(){
			if (loaded) {
				chart.updateSize();
				diffractionChart.updateSize();
				visarChart.updateSize();
				diffractionImage.updateSize();
			}
		};

		function onSelectionChange(query) {
			//d3.select('#selectionReadout').text("Selection: " + query);
			//console.log("onSelectionChange " + loaded + ' ' + query.length);
			diffractionChart.highlightData(query, "green");
			visarChart.highlightData(query, "green");
		}

		function onLineHover(i, event) {
			chart.setHighlight(i);
			onMouseOverChange(i, event);
		}

		function onMouseOverChange(i, event) {
			if (i != null) {
				//d3.select('#mouseOverReadout').text("Moused over: " + JSON.stringify(chart.results[i]));
				diffractionChart.selectData([i]);
				visarChart.selectData([i]);
			}
			else {
				diffractionChart.selectData([]);
				visarChart.selectData([]);
			}
		}

		function pad(num, size){ return ('000000000' + num).substr(-size); }
		
		function getDiffData(i) {
			if (loaded) {
				var id = chart.results[i].run;
				return [
					{file: "_1DSpectra/r" + pad(id,4) + "-e00000001-spectrum.txt", color: "blue", columnX: -1, columnY: -1},
					{file: "_1DSpectra/r" + pad(id,4) + "-e00000002-spectrum.txt", color: "red", columnX: -1, columnY: -1}];
			}

			return null;
		}

		function getVisarData(i) {
			if (loaded) {
				var id = chart.results[i].run;
				return [
					{file: "visar/r" + pad(id,3) + "-visar.txt", color: "blue", columnX: -1, columnY: 0},
					{file: "visar/r" + pad(id,3) + "-visar.txt", color: "red", columnX: -1, columnY: 1}];
					//,
					//{file: "visar/r" + pad(id,3) + ".txt", color: "blue", column: 0},
					//{file: "visar/r" + pad(id,3) + ".txt", color: "red", column: 1}];
			}

			return null;
		}

		function getVisarData2(i) {
			if (loaded) {
				var id = i+1;
				return [
					{file: "simresults/Shot104S_" + pad(id,3) + "_TitleAl5083.FreeSurface.000001", color: "blue", columnX: 1, columnY: 3, delimiter: " "}];
					//,
					//{file: "visar/r" + pad(id,3) + ".txt", color: "blue", column: 0},
					//{file: "visar/r" + pad(id,3) + ".txt", color: "red", column: 1}];
			}

			return null;
		}
	</script>
</body>
