<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset="utf-8">
	<meta name='author' content="Cameron Tauxe">
	<link rel='stylesheet' href='example.css'>
	<script src="d3.v3.min.js"></script>
	<script src="d3-queue.min.js"></script>
	<script src = 'ParallelCoordinatesChart.js'></script>
	<script src = 'LineChart.js'></script>
</head>
<body>
	<div id="header">
		<h1>Cinema Database Explorer</h1>
		<select id="database" onchange="load()">
			<option value="GF-HP/GF-HP.csv">GF-HP</option>
			<option value="GF-LP/GF-LP.csv">F-LP</option>
			<option value="LANLHigh-O/LANLHigh-O.csv">LANLHigh-O</option>
			<option value="LANLLow-O/LANLLow-O.csv">LANLLow-O</option>
			<option value="simresults/Al.design.1000.numbered.csv">Flag Simulation</option>
		</select>
	</div>
	<div id="svgArea">
		<div id="svgContainer"></div>
	</div>
	<div id="resultsArea" style="margin-left: auto; margin-right: auto;" width="100%">
		<!--canvas width="600" height="500" id="diffCanvas"></canvas-->
		<div id="visar" class="lineChart"></div>
		<div id="diffraction2D" class="imageChart"><img id="diffractionImage1" width="50%" height="100%" src="Ti-data/Ti-XRD-composite-images/output.jpg"><img id="diffractionImage2" width="50%" height="100%" src="Ti-data/Ti-XRD-composite-images/output.jpg"><!--img id="diffractionImage3" width="100%" height="50%" src="Ti-data/Ti-XRD-composite-images/output.jpg"--></div>
		<div id="diffraction1D" class="lineChart"></div>
		<div id="selectionReadout"></div>
		<div id="mouseOverReadout"></div>
	</div>

	<script>
		var loaded = false;
		var chart;
		var diffractionChart;
		var visarChart;
		var alwaysHighlighted = [];
		//var diffractionImage;
		load();

		function load() {

			d3.select('#svgContainer').html('');
			d3.select('#visar').html('');
			d3.select('#diffraction1D').html('');
			d3.select('#diffractionImage1').attr("src", "Ti-data/Ti-XRD-composite-images/output.jpg");
			d3.select('#diffractionImage2').attr("src", "Ti-data/Ti-XRD-composite-images/output.jpg");

			dbName = d3.select('#database').node().value;
			console.log(dbName);

			chart = new ParallelCoordinatesChart(d3.select('#svgContainer'),
												dbName,
												//'GF-HP/GF-HP.csv',
												//'GF-LP/GF-LP.csv',
												//'LANLHigh-O/LANLHigh-O.csv',
												//'LANLLow-O/LANLLow-O.csv',
												//'LANLMed-O/LANLMed-O.csv',
												//'simresults/Al.design.3.numbered.csv',
												//'simresults/Al.design.1000.numbered.csv',
												doneLoading,
												onSelectionChange,
												onMouseOverChange);
			diffractionChart = new LineChart(d3.select('#diffraction1D'), getDiffData, onLineHover, onRemoveSelection, onIncludeSelection);
			//diffractionImage = new LineChart(d3.select('#diffraction2D'), getDiffData, onLineHover);
			
			if (dbName == "simresults/Al.design.1000.numbered.csv") {
				visarChart = new LineChart(d3.select('#visar'), getVisarData2, onLineHover, onRemoveSelection, onIncludeSelection);
			}
			else {
				visarChart = new LineChart(d3.select('#visar'), getVisarData, onLineHover, onRemoveSelection, onIncludeSelection);
			}
		}

		var lastQuery = [];

		function doneLoading() {
			loaded = true;

			// Initialize lines
			var resultIndices = Array.apply(null, Array(chart.results.length)).map(function (_, i) {return i;});
			//diffractionChart.drawData(resultIndices, true, "lightgrey");
			diffractionChart.loadData(resultIndices);
			visarChart.loadData(resultIndices);
		}

		window.onresize = function(){
			if (loaded) {
				chart.updateSize();
				diffractionChart.updateSize();
				visarChart.updateSize();
				//diffractionImage.updateSize();
			}
		};

		function onSelectionChange(query) {
			//d3.select('#selectionReadout').text("Selection: " + query);
			//console.log("onSelectionChange " + loaded + ' ' + query.length);
			diffractionChart.highlightData(query, "green");
			visarChart.highlightData(query, "green");
			lastQuery = query;
		}

		function onLineHover(i, event) {
			chart.setHighlight(i);
			onMouseOverChange(i, event);
		}

		function onRemoveSelection(i, event) {
			for (var f = 0; f < lastQuery.length; f++) {
				if (lastQuery[f] == i) {
					lastQuery.splice(f, 1);
					break;
				}
			}

			diffractionChart.highlightData(lastQuery, "green");
			visarChart.highlightData(lastQuery, "green");
		}

		function onIncludeSelection(i, event) {
			var found = false;
			for (var f = 0; f < lastQuery.length; f++) {
				if (lastQuery[f] == i) {
					found = true;
					break;
				}
			}

			if (!found) {
				lastQuery.push(i);

				diffractionChart.highlightData(lastQuery, "green");
				visarChart.highlightData(lastQuery, "green");
			}

		}

		function onMouseOverChange(i, event) {
			if (i != null) {
				var id = chart.results[i].run;
				diffractionChart.selectData([i].concat(alwaysHighlighted));
				visarChart.selectData([i].concat(alwaysHighlighted));
				if (dbName == "simresults/Al.design.1000.numbered.csv") {
					fileName = "Ti-data/Ti-XRD-composite-images/output.jpg";
					fileName2 = "Ti-data/Ti-XRD-composite-images/output.jpg";
				}
				else {
					var fileName = "Ti-data/Ti-XRD-composite-images/r"+ pad(id, 4) + "-e001-140506-Composite.tif.jpg";
					if (id >= 223 && id <= 372) {
						fileName = "Ti-data/Ti-XRD-composite-images/r"+ pad(id, 3) + "-e001-140506-Composite.tif.jpg";
					}
					var fileName2 = "Ti-data/Ti-XRD-composite-images/r"+ pad(id, 4) + "-e002-140506-Composite.tif.jpg";
					if (id >= 223 && id <= 372) {
						fileName2 = "Ti-data/Ti-XRD-composite-images/r"+ pad(id, 3) + "-e002-140506-Composite.tif.jpg";
					}
				}
				d3.select('#diffractionImage1').attr("src", fileName);
				d3.select('#diffractionImage2').attr("src", fileName2);
				//console.log(fileName);
			}
			else {
				diffractionChart.selectData(alwaysHighlighted);
				visarChart.selectData(alwaysHighlighted);
				//d3.select('#diffractionImage1').attr("src", "Ti-data/Ti-XRD-composite-images/output.jpg");
				//d3.select('#diffractionImage2').attr("src", "Ti-data/Ti-XRD-composite-images/output.jpg");
				//d3.select('#diffraction2D').attr("src", "");
			}
		}

		function pad(num, size){ return ('000000000' + num).substr(-size); }
		
		function getDiffData(i) {
			if (loaded) {
				var id = chart.results[i].run;
				return [
					{file: "_1DSpectra/r" + pad(id,4) + "-e00000001-spectrum.txt", color: "blue", columnX: -1, columnY: -1},
					{file: "_1DSpectra/r" + pad(id,4) + "-e00000002-spectrum.txt", color: "red", columnX: -1, columnY: -1}];
			}

			return null;
		}

		function getVisarData(i) {
			if (loaded) {
				var id = chart.results[i].run;
				return [
					{file: "visar/r" + pad(id,3) + "-visar.txt", color: "blue", columnX: -1, columnY: 0},
					{file: "visar/r" + pad(id,3) + "-visar.txt", color: "red", columnX: -1, columnY: 1}];
			}

			return null;
		}

		function getVisarData2(i) {
			if (loaded) {
				var id = i+1;
				var experiment = chart.results[i].Experiment;
				if (experiment == 1) {
					alwaysHighlighted.push(i);
					return [{file: "Boetler-data/Data_S" + pad(chart.results[i].id,3) + "E.txt", color: "red", columnX: 3, columnY: 2}];
				}
				else {
					return [
						{file: "simresults/Shot104S_" + pad(id,3) + "_TitleAl5083.FreeSurface.000001", color: "blue", columnX: 1, columnY: 3, delimiter: " "}];
				}
			}

			return null;
		}
	</script>
</body>
